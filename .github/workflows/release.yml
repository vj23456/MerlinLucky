name: MerlinLucky Release

on:
  push:
    tags:
      - 'v*.*'  # åŒ¹é… v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾

env:
  PACKAGE_PREFIX: "MerlinLucky"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get version from tag
      id: get_version
      run: |
        TAG_NAME="${{ github.ref_name }}"
        VERSION="${TAG_NAME#v}"
        
        if [[ ! $VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
          echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼ '$VERSION'"
          exit 1
        fi
        
        echo "âœ… ç‰ˆæœ¬å·: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
    
    - name: Validate project structure
      run: |
        echo "ğŸ” éªŒè¯é¡¹ç›®ç»“æ„..."
        if [ ! -f "config.json.js" ]; then echo "âŒ config.json.js ä¸å­˜åœ¨"; exit 1; fi
        if [ ! -d "lucky" ]; then echo "âŒ lucky ç›®å½•ä¸å­˜åœ¨"; exit 1; fi
        echo "âœ… éªŒè¯é€šè¿‡"
    
    - name: Extract changelog for version
      id: extract_changelog
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        if [ ! -f "Changelog.txt" ]; then
          echo "changelog=" >> $GITHUB_OUTPUT
          exit 0
        fi
        CHANGELOG_CONTENT=$(awk -v ver="$VERSION" '
          /^[0-9]+\.[0-9]+\.[0-9]+$/ {if ($0==ver) {found=1; next}} 
          found && /^[0-9]+\.[0-9]+\.[0-9]+$/ {found=0} 
          found {print}
        ' Changelog.txt)
        CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed '/^[[:space:]]*$/d')
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    # ç¬¬ä¸€æ­¥ï¼šæ›´æ–° config.json.js ä¸­çš„ version å­—æ®µï¼ˆæš‚ä¸æäº¤ï¼‰
    - name: Update version in config.json.js
      id: update_version
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "ğŸ”„ æ›´æ–° config.json.js ä¸­çš„ version å­—æ®µä¸º $VERSION"
        sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" config.json.js
        # éªŒè¯æ›´æ–°
        NEW_VER=$(grep -o '"version": "[^"]*"' config.json.js | cut -d'"' -f4)
        if [ "$NEW_VER" != "$VERSION" ]; then
          echo "âŒ ç‰ˆæœ¬æ›´æ–°å¤±è´¥"
          exit 1
        fi
        echo "âœ… version å·²æ›´æ–°"
    
    # ç¬¬äºŒæ­¥ï¼šæ›´æ–° lucky/version æ–‡ä»¶ï¼ˆæš‚ä¸æäº¤ï¼‰
    - name: Update lucky/version file
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        mkdir -p lucky
        echo "$VERSION" > lucky/version
        echo "âœ… lucky/version å·²æ›´æ–°ä¸º $VERSION"
    
    # ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º tar.gz å‹ç¼©åŒ…
    - name: Create tar.gz archive
      id: create_archive
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        ARCHIVE_NAME="${PACKAGE_PREFIX}_v${VERSION}.tar.gz"
        tar --exclude='.git*' --exclude='.github' --exclude='*.tar.gz' \
            --exclude='*.backup' -czf "$ARCHIVE_NAME" lucky/
        
        # è®¡ç®— MD5 å€¼ï¼ˆLinux md5sum å‘½ä»¤è¾“å‡ºæ ¼å¼ï¼šmd5sum filenameï¼‰
        MD5=$(md5sum "$ARCHIVE_NAME" | cut -d' ' -f1)
        
        echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ: $ARCHIVE_NAME"
        echo "ğŸ“Š MD5: $MD5"
        echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
        echo "file_count=$(tar -tzf "$ARCHIVE_NAME" | wc -l)" >> $GITHUB_OUTPUT
        echo "md5=$MD5" >> $GITHUB_OUTPUT
    
    # ç¬¬å››æ­¥ï¼šæ›´æ–° config.json.js ä¸­çš„ md5 å­—æ®µ
    - name: Update md5 in config.json.js
      id: update_md5
      run: |
        MD5="${{ steps.create_archive.outputs.md5 }}"
        echo "ğŸ”„ æ›´æ–° config.json.js ä¸­çš„ md5 å­—æ®µä¸º $MD5"
        
        # æ£€æŸ¥ config.json.js ä¸­æ˜¯å¦å­˜åœ¨ md5 å­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
        if grep -q '"md5":' config.json.js; then
          sed -i.bak "s/\"md5\": \".*\"/\"md5\": \"$MD5\"/" config.json.js
        else
          # åœ¨ version è¡Œåæ·»åŠ  md5 è¡Œï¼ˆç®€å•å¤„ç†ï¼ŒæŒ‰éœ€è°ƒæ•´ï¼‰
          sed -i.bak "/\"version\":/a\  \"md5\": \"$MD5\"," config.json.js
        fi
        
        # éªŒè¯æ›´æ–°
        NEW_MD5=$(grep -o '"md5": "[^"]*"' config.json.js | cut -d'"' -f4)
        if [ "$NEW_MD5" != "$MD5" ]; then
          echo "âŒ MD5 æ›´æ–°å¤±è´¥"
          exit 1
        fi
        echo "âœ… md5 å·²æ›´æ–°ä¸º $MD5"
    
    # ç¬¬äº”æ­¥ï¼šæäº¤æ‰€æœ‰æ›´æ”¹åˆ°ä»“åº“
    - name: Commit version and md5 updates
      id: commit_updates
      run: |
        # é…ç½® git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
        git add config.json.js lucky/version
        
        if git diff --cached --quiet; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ£€æµ‹åˆ°ä»¥ä¸‹æ›´æ”¹ï¼š"
          git status --porcelain
          COMMIT_MSG="chore: update version to ${{ steps.get_version.outputs.version }} and md5"
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git branch --show-current)
          if [ -z "$CURRENT_BRANCH" ]; then
            # detached HEAD çŠ¶æ€ï¼Œæ¨é€åˆ° main åˆ†æ”¯
            git push origin HEAD:main
          else
            git push origin HEAD:"$CURRENT_BRANCH"
          fi
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    # ç¬¬å…­æ­¥ï¼šåˆ›å»º GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: MerlinLucky v${{ steps.get_version.outputs.version }}
        body: |
          ### ğŸ“ æ›´æ–°å†…å®¹
          ${{ steps.extract_changelog.outputs.changelog }}
          
          æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—ï¼š**[Changelog.txt](https://github.com/${{ github.repository }}/blob/main/Changelog.txt)**
        files: |
          ${{ steps.create_archive.outputs.archive_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup
      if: always()
      run: rm -f config.json.js.bak lucky/version.backup 2>/dev/null || true
    
    - name: Success
      if: success()
      run: echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"