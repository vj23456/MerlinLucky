name: MerlinClash Release

on:
  push:
    tags:
      - 'v*.*'  # åŒ¹é… v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾

env:
  PACKAGE_PREFIX: "merlinclash"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from tag
      id: get_version
      run: |
        # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤ 'v' å‰ç¼€ï¼‰
        TAG_NAME="${{ github.ref_name }}"
        VERSION="${TAG_NAME#v}"
        
        # éªŒè¯ç‰ˆæœ¬å·
        if [[ ! $VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
          echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼ '$VERSION'"
          echo "è¯·ä½¿ç”¨ç±»ä¼¼ v1.5.9 çš„æ ¼å¼"
          exit 1
        fi
        
        echo "âœ… ç‰ˆæœ¬å·: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
    
    - name: Validate project structure
      run: |
        echo "ğŸ” éªŒè¯é¡¹ç›®ç»“æ„..."
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        REQUIRED_FILES=("config.json.js" "Changelog.txt")
        REQUIRED_DIRS=("lucky")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ é”™è¯¯ï¼š$file æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
        done
        
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ é”™è¯¯ï¼š$dir ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
        done
        
        echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"
        echo "ğŸ“ lucky ç›®å½•æ–‡ä»¶æ•°é‡:"
        find lucky -type f | wc -l
    
    - name: Extract changelog for version
      id: extract_changelog
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "ğŸ“ ä» Changelog.txt æå–ç‰ˆæœ¬ $VERSION çš„æ›´æ–°å†…å®¹..."
        
        # æ£€æŸ¥ Changelog.txt æ–‡ä»¶
        if [ ! -f "Changelog.txt" ]; then
          echo "âŒ é”™è¯¯ï¼šChangelog.txt æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æå–æŒ‡å®šç‰ˆæœ¬çš„å†…å®¹
        # ä½¿ç”¨ awk æå–ä»æŒ‡å®šç‰ˆæœ¬å·å¼€å§‹åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·æˆ–æ–‡ä»¶ç»“æŸçš„å†…å®¹
        CHANGELOG_CONTENT=$(awk -v version="$VERSION" '
        BEGIN { found=0; capture=0 }
        /^[0-9]+\.[0-9]+\.[0-9]+$/ {
          if ($0 == version) {
            found=1
            capture=1
            next
          }
          if (capture && /^[0-9]+\.[0-9]+\.[0-9]+$/) {
            capture=0
          }
        }
        capture && found {
          print $0
        }
        ' Changelog.txt)
        
        # å¦ä¸€ç§æ–¹æ³•ï¼šä½¿ç”¨ sed æå–
        # ä»ç‰ˆæœ¬å·è¡Œå¼€å§‹ï¼Œåˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·è¡Œæˆ–æ–‡ä»¶ç»“æŸ
        CHANGELOG_CONTENT_ALT=$(sed -n "/^$VERSION$/,/^[0-9]+\.[0-9]+\.[0-9]+$/p" Changelog.txt | sed '$d' | sed '1d')
        
        # å¦‚æœç¬¬ä¸€ç§æ–¹æ³•æ²¡æ‰¾åˆ°å†…å®¹ï¼Œå°è¯•ç¬¬äºŒç§æ–¹æ³•
        if [ -z "$CHANGELOG_CONTENT" ] && [ -n "$CHANGELOG_CONTENT_ALT" ]; then
          CHANGELOG_CONTENT="$CHANGELOG_CONTENT_ALT"
        fi
        
        # å»é™¤é¦–å°¾ç©ºç™½è¡Œ
        CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed '/^[[:space:]]*$/d' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        
        if [ -n "$CHANGELOG_CONTENT" ]; then
          echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ›´æ–°å†…å®¹:"
          echo "----------------------------------------"
          echo "$CHANGELOG_CONTENT"
          echo "----------------------------------------"
          
          # å°†å†…å®¹è½¬æ¢ä¸º JSON æ ¼å¼ä»¥ä¾¿åœ¨ GitHub Actions ä¸­ä½¿ç”¨
          CHANGELOG_JSON=$(echo "$CHANGELOG_CONTENT" | jq -R -s -c . 2>/dev/null || echo "$CHANGELOG_CONTENT")
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ›´æ–°å†…å®¹"
          echo "changelog=" >> $GITHUB_OUTPUT
        fi
        
        # æ˜¾ç¤º Changelog.txt çš„æ ¼å¼ç¤ºä¾‹
        echo ""
        echo "ğŸ“‹ Changelog.txt æ–‡ä»¶æ ¼å¼ç¤ºä¾‹:"
        head -20 Changelog.txt
    
    - name: Update version in files
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        
        echo "ğŸ”„ æ›´æ–°æ–‡ä»¶ç‰ˆæœ¬å·..."
        
        # 1. æ›´æ–° config.json.js
        echo "æ›´æ–° config.json.js..."
        if grep -q '"version":' config.json.js; then
          sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" config.json.js
          echo "âœ… config.json.js æ›´æ–°å®Œæˆ"
          
          # éªŒè¯æ›´æ–°
          NEW_VERSION=$(grep -o '"version": "[^"]*"' config.json.js | cut -d'"' -f4)
          if [ "$NEW_VERSION" = "$VERSION" ]; then
            echo "âœ… éªŒè¯é€šè¿‡: $NEW_VERSION"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼ŒæœŸæœ›: $VERSION, å®é™…: $NEW_VERSION"
            exit 1
          fi
        else
          echo "âŒ config.json.js ä¸­æ²¡æœ‰æ‰¾åˆ° version å­—æ®µ"
          exit 1
        fi
        
        # 2. æ›´æ–° lucky/version æ–‡ä»¶
        echo "æ›´æ–° lucky/version..."
        mkdir -p lucky
        echo "$VERSION" > lucky/version
        echo "âœ… lucky/version æ›´æ–°å®Œæˆ"
        echo "ğŸ“„ lucky/version å†…å®¹:"
        cat lucky/version
    
    - name: Create tar.gz archive
      id: create_archive
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        ARCHIVE_NAME="${PACKAGE_PREFIX}_v${VERSION}.tar.gz"
        
        echo "ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…: $ARCHIVE_NAME"
        
        # åˆ—å‡ºå°†è¦æ‰“åŒ…çš„æ–‡ä»¶
        echo "ğŸ“ æ‰“åŒ…æ–‡ä»¶åˆ—è¡¨ (å‰20ä¸ª):"
        find lucky -type f | sort | head -20
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar --exclude='.git*' \
            --exclude='.github' \
            --exclude='*.tar.gz' \
            --exclude='*.zip' \
            --exclude='*.backup' \
            --exclude='test*' \
            --exclude='*test*' \
            -czf "$ARCHIVE_NAME" lucky/
        
        # éªŒè¯å‹ç¼©åŒ…
        if [ ! -f "$ARCHIVE_NAME" ]; then
          echo "âŒ å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        # æ˜¾ç¤ºå‹ç¼©åŒ…ä¿¡æ¯
        ARCHIVE_SIZE=$(du -h "$ARCHIVE_NAME" | cut -f1)
        FILE_COUNT=$(tar -tzf "$ARCHIVE_NAME" | wc -l)
        SHA256_SUM=$(sha256sum "$ARCHIVE_NAME" | cut -d' ' -f1)
        
        echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
        echo "ğŸ“Š å‹ç¼©åŒ…è¯¦æƒ…:"
        echo "  åç§°: $ARCHIVE_NAME"
        echo "  å¤§å°: $ARCHIVE_SIZE"
        echo "  æ–‡ä»¶æ•°: $FILE_COUNT"
        echo "  SHA256: $SHA256_SUM"
        
        # ä¿å­˜è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "sha256_sum=$SHA256_SUM" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: MerlinClash v${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: false  # ç¦ç”¨è‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨è‡ªå®šä¹‰å†…å®¹
        
        # åŠ¨æ€ç”Ÿæˆ release body
        body: |
          ## ğŸš€ MerlinClash v${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ å‘è¡ŒåŒ…
          - **æ–‡ä»¶å**: ${{ steps.create_archive.outputs.archive_name }}
          - **åŒ…å«æ–‡ä»¶æ•°**: ${{ steps.create_archive.outputs.file_count }}
          - **SHA256**: `${{ steps.create_archive.outputs.sha256_sum }}`
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          ${{ steps.extract_changelog.outputs.changelog }}
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `${{ steps.create_archive.outputs.archive_name }}`
          2. è§£å‹æ–‡ä»¶ï¼š`tar -xzf ${{ steps.create_archive.outputs.archive_name }}`
          3. æŸ¥çœ‹è§£å‹åçš„ lucky ç›®å½•
          
          ### ğŸ“‹ ç‰ˆæœ¬å†å²
          æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—ï¼š**[Changelog.txt](https://github.com/${{ github.repository }}/blob/main/Changelog.txt)**
          
          ---
          *æœ¬å‘å¸ƒç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
        files: |
          ${{ steps.create_archive.outputs.archive_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Post-release cleanup
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f config.json.js.bak
        rm -f lucky/version.backup 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"
    
    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ å‘å¸ƒæµç¨‹å®Œæˆï¼"
        echo "========================================"
        echo "ç‰ˆæœ¬: v${{ steps.get_version.outputs.version }}"
        echo "å‹ç¼©åŒ…: ${{ steps.create_archive.outputs.archive_name }}"
        echo "æ›´æ–°å†…å®¹:"
        echo "${{ steps.extract_changelog.outputs.changelog }}"
        echo "å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag_name }}"
        echo "========================================"
